pipeline {
    agent any

    environment {
        PROJECT_NAME = "E-commerce-project-springBoot"
        GITHUB_REPO_URL = "https://github.com/Pramod581/E-commerce-project-springBoot.git"

        EC2_SSH_CRED_ID = "ec2-ssh-key-id"
        EC2_USER = "ubuntu"
        EC2_HOST = "13.56.193.207"
        EC2_APP_PATH = "/home/ubuntu"
        RDS_ENDPOINT = "ecommerce-db.cbs6ioc2g5vw.us-west-1.rds.amazonaws.com"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: "${GITHUB_REPO_URL}"
            }
        }

        stage('Build') {
            steps {
                sh 'cd JtProject && MAVEN_OPTS="-Xmx512m" mvn clean package -DskipTests'
            }
        }

        stage('Deploy to EC2') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'ecommerce-db-secret',
                        passwordVariable: 'DB_PASSWORD',
                        usernameVariable: 'DB_USER'
                    )
                ]) {

                    sshagent([EC2_SSH_CRED_ID]) {

                        // Copy JAR to EC2
                        sh """
                        scp -o StrictHostKeyChecking=no JtProject/target/*.jar ${EC2_USER}@${EC2_HOST}:${EC2_APP_PATH}/
                        """

                        // Run commands on EC2
                        sh """
                        ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} "
                          cd /home/ubuntu;

                          sudo pkill -f java || true;

                          echo 'spring.datasource.username=${DB_USER}' > application.properties;
                          echo 'spring.datasource.password=${DB_PASSWORD}' >> application.properties;
                          echo 'spring.datasource.url=jdbc:mysql://${RDS_ENDPOINT}:3306/ecommerce' >> application.properties;

                          JAR_NAME=\\\$(ls -t *.jar | head -n 1);

                          nohup java -jar \\\$JAR_NAME --spring.config.location=/home/ubuntu/application.properties > app.log 2>&1 &
                        "
                        """
                    }
                }
            }
        }

        stage('Validate Deployment') {
            steps {
                sh "sleep 15"
                sh "curl -I http://${EC2_HOST}:8080 || true"
            }
        }
    }

    post {
        success {
            echo '✅ Deployment Success!'
        }
        failure {
            echo '❌ Deployment Failed'
        }
    }
}







