pipeline {
    agent any

    environment {
        PROJECT_NAME = "E-commerce-project-springBoot"
        GITHUB_REPO_URL = "https://github.com/Pramod581/E-commerce-project-springBoot.git"

        EC2_SSH_CRED_ID = "ec2-ssh-key-id"
        EC2_USER = "ubuntu"
        EC2_HOST = "54.176.77.0"
        EC2_APP_PATH = "/home/ubuntu/app.jar"
        RDS_ENDPOINT = "ecommerce-db.cbs6ioc2g5vw.us-west-1.rds.amazonaws.com"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: "${GITHUB_REPO_URL}"
            }
        }

        stage('Build') {
            steps {
                sh 'cd JtProject && mvn clean package -DskipTests'
            }
        }

        stage('Test') {
            steps {
                sh 'cd JtProject && mvn test -Dspring.profiles.active=test'
            }
        }

        stage('Deploy to EC2') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'ecommerce-db-secret',
                        passwordVariable: 'DB_PASSWORD',
                        usernameVariable: 'DB_USER'
                    )
                ]) {

                    sshagent([EC2_SSH_CRED_ID]) {

                        sh """
                        scp -o StrictHostKeyChecking=no JtProject/target/*.jar ${EC2_USER}@${EC2_HOST}:${EC2_APP_PATH}
                        """

                        sh """
                        ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} '
                        pkill -f java || true
                        echo "spring.datasource.username=${DB_USER}" > application.properties
                        echo "spring.datasource.password=${DB_PASSWORD}" >> application.properties
                        echo "spring.datasource.url=jdbc:mysql://${RDS_ENDPOINT}:3306/ecommerce" >> application.properties
                        nohup java -jar ${EC2_APP_PATH} --spring.config.location=application.properties > app.log 2>&1 &
                        '
                        """
                    }
                }
            }
        }

        stage('Validate Deployment') {
            steps {
                sh "sleep 10"
                sh "curl -I http://${EC2_HOST}:8080"
            }
        }
    }

    post {
        always {
            cleanWs()
        }

        success {
            echo '✅ Pipeline completed successfully!'
        }

        failure {
            echo '❌ Pipeline failed. Check logs.'
        }
    }
}





