pipeline {
    agent any

    environment {
        PROJECT_NAME = "E-commerce-project-springBoot"
        GITHUB_REPO_URL = "https://github.com/Pramod581/E-commerce-project-springBoot.git"

        EC2_SSH_CRED_ID = "ec2-ssh-key-id"
        EC2_USER = "ubuntu"
        EC2_HOST = "54.215.41.3"
        EC2_APP_PATH = "/home/ubuntu/app.jar"
        RDS_ENDPOINT = "ecommerce-db.cbs6ioc2g5vw.us-west-1.rds.amazonaws.com"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: "${GITHUB_REPO_URL}"
            }
        }

        stage('Build') {
            steps {
                sh 'mvn clean package'
            }
        }

        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }

        stage('Deploy to EC2') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'ecommerce-db-secret',
                        passwordVariable: 'DB_PASSWORD',
                        usernameVariable: 'DB_USER'
                    )
                ]) {
                    sshagent([EC2_SSH_CRED_ID]) {
                        sh """
                            # copy JAR
                            scp target/*.jar ${EC2_USER}@${EC2_HOST}:${EC2_APP_PATH}

                            # overwrite application.properties
                            ssh ${EC2_USER}@${EC2_HOST} "
                                sudo rm -f /home/ubuntu/application.properties
                                echo 'spring.datasource.username=${DB_USER}' | sudo tee /home/ubuntu/application.properties
                                echo 'spring.datasource.password=${DB_PASSWORD}' | sudo tee -a /home/ubuntu/application.properties
                                echo 'spring.datasource.url=jdbc:mysql://${RDS_ENDPOINT}:3306/ecommerce' | sudo tee -a /home/ubuntu/application.properties
                            "

                            # restart application
                            ssh ${EC2_USER}@${EC2_HOST} 'sudo systemctl restart springboot-app'
                        """
                    }
                }
            }
        }

        stage('Validate Deployment') {
            steps {
                sh "curl -I http://${EC2_HOST}:8080"
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        success {
            echo '✅ Pipeline completed successfully!'
        }
        failure {
            echo '❌ Pipeline failed. Check logs.'
        }
    }
}



