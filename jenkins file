pipeline {
    agent any

    environment {
        // Project Info
        PROJECT_NAME = "E-commerce-project-springBoot"
        GITHUB_REPO_URL = "https://github.com/Pramod581/E-commerce-project-springBoot.git"

        // Jenkins credentials injected as environment variables
        DB_USER = credentials('ecommerce-db-secret').username
        DB_PASSWORD = credentials('ecommerce-db-secret').password
        EC2_SSH_CRED_ID = "ec2-ssh-key-id"

        // Deployment Targets
        EC2_USER = "ubuntu"
        EC2_HOST = "54.215.41.3"          // Replace with your Terraform EC2 public IP
        EC2_APP_PATH = "/home/ubuntu/app.jar"
        RDS_ENDPOINT = "ecommerce-db.cbs6ioc2g5vw.us-west-1.rds.amazonaws.com"   // Replace with your actual RDS endpoint
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: "${GITHUB_REPO_URL}"
            }
        }

        stage('Build') {
            steps {
                sh 'mvn clean package'
            }
        }

        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }

        stage('Deploy to EC2') {
            steps {
                sshagent([EC2_SSH_CRED_ID]) {
                    sh """
                        # Copy the built JAR to EC2
                        scp target/*.jar ${EC2_USER}@${EC2_HOST}:${EC2_APP_PATH}

                        # Inject DB credentials and RDS endpoint into application.properties
                        ssh ${EC2_USER}@${EC2_HOST} "
                            echo 'spring.datasource.username=${DB_USER}' | sudo tee -a /home/ubuntu/application.properties
                            echo 'spring.datasource.password=${DB_PASSWORD}' | sudo tee -a /home/ubuntu/application.properties
                            echo 'spring.datasource.url=jdbc:mysql://${RDS_ENDPOINT}:3306/ecommerce' | sudo tee -a /home/ubuntu/application.properties
                        "

                        # Restart the Spring Boot systemd service
                        ssh ${EC2_USER}@${EC2_HOST} 'sudo systemctl restart springboot-app'
                    """
                }
            }
        }

        stage('Validate Deployment') {
            steps {
                sh "curl -I http://${EC2_HOST}:8080"
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed. Check logs.'
        }
    }
}


